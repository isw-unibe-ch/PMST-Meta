---
title: "Map and use case plots for JOHD"
author: "Sandra Auderset"
format: pdf
editor: visual
---

```{r}
#| include: false
library(here)
library(tidyverse)
library(ggpubr)
library(ggsci)
library(janitor)
library(viridis)
```

# Map of languages

Map showing the languages with group affiliation included in the current release.

```{r}
#| include: false
# packages and keys for maps
library(ggmap)
library(ggrepel)
library(ggsci)
library(ggthemes)
library(cowplot)
library(sf)

# Google Maps and Stadia Maps APIs
register_google(key = "AIzaSyBgaOp_Lnz-A2vmQrIBKOxX67uxLgW-Z8M", write = FALSE)
register_stadiamaps("3a811dbc-3a12-4a65-a604-94e474a482af", write = FALSE)
```

```{r}
# read in metadata
metadata <- read_tsv(here("language_metadata.tsv"))
```

```{r}
# create base map by finding edge points
summary(metadata$Longitude)
summary(metadata$Latitude)
# base map
map_northeast <- get_googlemap(center = c(lon = 93, lat = 23.6),
                               zoom = 7,
                               maptype = "hybrid")
# add points
map_ne_sample <- ggmap(map_northeast) +
  geom_point(aes(x = Longitude, y = Latitude, color = Group), data = metadata, size = 3.5) +
  geom_label_repel(aes(x = Longitude, y = Latitude, label = Language_Name, segment.colour = "white"), data = metadata,
                    point.padding = 0.3,
                    box.padding = 0.7,
                    min.segment.length = 0.1,
                   size = 4) + 
  scale_color_tron(name = "Group") +
  ggthemes::theme_map()
map_ne_sample

# write out to file
# ggsave(here("plots/map_languages.png"), map_ne_sample, height = 15, width = 15, units = "cm", dpi = 600)
```

Map of India with square indicating the region of the detailed map.

```{r}
# base map india
map_india <- get_stadiamap(bbox = c(73, 7, 98, 31),
                           maptype = "stamen_toner",
                           zoom = 5)

# add square
map_india_sq <- ggmap(map_india) +
  geom_rect(aes(xmin = 89.5, xmax = 96.5, ymin = 20, ymax = 26.5), 
             fill = NA, color = "red", linewidth = 0.5) +
  ggthemes::theme_map() +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
map_india_sq
```

Combine the maps into one.

```{r}
map_combined <- ggdraw() +
  draw_plot(map_ne_sample) +
  draw_plot(map_india_sq, 
            x = -0.31, y = 0.64, 
            height = 0.35,
            valign = 0, halign = 0)
map_combined

# write out to file
ggsave(here("plots/map_languages_inset.png"), map_combined, height = 15, width = 15, units = "cm", dpi = 600)
```

### Map with key features (clusivity, number, etc.)

```{r}
# add variable with clusivity and dual
has_dual <- features_combined %>%
  filter(value_id=="DU") %>%
  distinct(language_id) %>%
  pull()
has_clusivity <- features_combined %>%
  filter(value_id=="INCL") %>%
  distinct(language_id) %>%
  pull()
# add to df
sample_features <- sample %>%
  mutate(dual = if_else(language_id %in% has_dual, "dual", "no dual")) %>%
  mutate(clusivity = if_else(language_id %in% has_clusivity, "clusivity", "no clusivity"))

# make map
map_ne_sample_features <- ggmap(map_northeast) +
  geom_point(aes(x = longitude, y = latitude, shape = clusivity, color = dual), data = sample_features, size = 3.5) +
  geom_label_repel(aes(x = longitude, y = latitude, label = language_name, segment.colour = "white"), data = sample_features,
                   point.padding = 0.3,
                   box.padding = 0.7,
                   min.segment.length = 0.1,
                   size = 4) + 
  scale_color_tron() +
  theme_map() +
  theme(legend.title=element_blank())
map_ne_sample_features

# write out to file
ggsave(here("plots/map_sample_features.png"), map_ne_sample_features, height = 15, width = 15, units = "cm", dpi = 600)
```

# Language-specific overviews

```{r}
# language name as string
lang_t <- ("ranglong")
# language name as object
lang_o <- noquote(lang_t)

```

```{r}
# read in scenario file, forms and morphemes
scenarios <- read_tsv(here("paradigms_in/scenarios.tsv"))
scenario_levels <- read_lines(here("scripts/scenario_levels.txt"))

# read in forms and morphemes, merge each with scenarios
forms_scen <- read_csv(here("PARALEX/ranglong/ranglong_forms.csv")) %>%
  left_join(., scenarios, by = c("cell"="Scenario_ID"))

morphs_scen <- read_csv(here("PARALEX/ranglong/ranglong_morphemes.csv")) %>%
  separate_longer_delim(in_scenarios, delim = ";") %>%
  separate_longer_delim(in_forms, delim = ";") %>%
  distinct() %>%
  mutate(across(starts_with("in_"), ~str_squish(.x))) %>%
  left_join(., scenarios, by = c("in_scenarios"="Scenario_ID")) %>%
  mutate(across(c(A_Number, O_Number), ~factor(.x, levels = c("SG", "DU", "PL"))),
         position = factor(position, levels = c("pre", "post", "free")),
         Scen_Person_Number = factor(Scen_Person_Number, levels = scenario_levels)) %>%
  droplevels() %>% 
  distinct() %>%
  arrange(morpheme, position, Scen_Person_Number)
glimpse(morphs_scen)
```

```{r}
#library(GGally)
#library(ggmosaic)

# morphs_test <- morphs_scen %>%
#   select(morpheme, position, TENSE_ASPECT:O_Clusivity) %>%
#   mutate(across(c(POLARITY, A_Clusivity, O_Clusivity), ~as.factor(.x))) %>%
#   mutate(position = factor(position, levels = c("pre", "post", "free"))) %>%
#   mutate(across(ends_with("Number"), ~factor(.x, levels = c("SG", "DU", "PL")))) %>%
#   mutate(TENSE_ASPECT = factor(TENSE_ASPECT, levels = c("NFUT", "FUT"))) %>%
#   droplevels() %>%
#   arrange(position)

# by tense/aspect and polarity vs. pronouns
morphs_counts_tap <- morphs_scen %>%
  count(morpheme, TENSE_ASPECT, POLARITY,.drop = FALSE) %>%
  mutate(TENSE_ASPECT = if_else(is.na(TENSE_ASPECT), "PRON", TENSE_ASPECT)) %>%
  unite("TAP", TENSE_ASPECT:POLARITY, sep = ".", na.rm = TRUE) %>%
  mutate(TAP = factor(TAP, levels = c("NFUT.AFF", "NFUT.NEG", "FUT.AFF", "FUT.NEG", "PRON")))
# plot
lz_five <- c(
  "#1F77B4",  # Dark Blue
  "#A6C8E0",  # Light Blue
  "#FF7F0E",  # Dark Orange
  "#FFBB78",  # Light Orange
  "#2CA02C"   # Green
)

distribution_tap <- ggplot(morphs_counts_tap) +
  geom_histogram(aes(x = morpheme, y = n, fill = TAP), 
                 stat = "identity", position = "fill") +
  #scale_fill_locuszoom(name = "Paradigm") +
  scale_fill_manual(values = lz_five, name = "Paradigm") +
  theme_bw() +
  theme(legend.position = "top",
        axis.title = element_blank())
distribution_tap

# by person scenario
morphs_counts_p <- morphs_scen %>%
  count(morpheme, Scen_Person,.drop = FALSE) %>%
  arrange(Scen_Person)
# plot with extended color schema
lz_ten <- c(
  "#FF6F6F",  # Light Pink
  "#D62728",  # Medium Red
  "#A50034",  # Dark Red
  "#FFD700",  # Light Yellow/Gold
  "#FFB84D",  # Medium Orange
  "#E67E22",  # Dark Orange
  "#17BECF",  # Dark Teal
  "#66C2C6",  # Medium Teal
  "#008C8C",  # Dark Cyan
  "#005B5B"   # Deep Teal
)


distribution_person <- ggplot(morphs_counts_p, aes(x = morpheme, y = n, fill = Scen_Person)) +
  geom_histogram(stat = "identity", position = "fill", binwidth = 1) +
  scale_fill_manual(values = lz_ten, name = "Person") +
  guides(fill = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(legend.position = "top",
        axis.title = element_blank())
distribution_person

# by number scenario
morphs_counts_n <- morphs_scen %>%
  unite("Scen_Number", c(A_Number, O_Number), sep = ">", na.rm = TRUE) %>% 
  mutate(Scen_Number = factor(Scen_Number, levels = c("SG", "SG>SG", "SG>PL", "PL", "PL>SG", "PL>PL"))) %>%
  count(morpheme, Scen_Number,.drop = FALSE) %>%
  arrange(Scen_Number)

lz_six <- c(
  "#2B7A4D",  # Dark Green
  "#5EBB8D",  # Medium Green
  "#A8D5BA",  # Light Green
  "#5E2B91",  # Dark Purple
  "#A77BCA",  # Medium Purple
  "#D6C3E0"   # Light Purple
)



distribution_number <- ggplot(morphs_counts_n, aes(x = morpheme, y = n, fill = Scen_Number)) +
  geom_histogram(stat = "identity", position = "fill", binwidth = 1) +
  #scale_fill_jco(name = "Number") +
  scale_fill_manual(values = lz_six, name = "Number") +
  guides(fill = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(legend.position = "top",
        axis.title = element_blank())
distribution_number

# combine plots into one
distribution_combined <- ggarrange(distribution_tap, distribution_person, distribution_number, 
                                   ncol = 1, align = "hv")
distribution_combined

ggsave(here("plots/distribution_profile.png"), distribution_combined,
       height = 25, width = 40, units = "cm", dpi = 600)
```

Make cross-tables like in publications.

```{r}
# pronouns
pronouns_visual <- forms_scen %>%
  filter(str_detect(cell, "PRON")) %>%
  select(cell, analysed_phon_form) %>%
  mutate(cell = str_remove_all(cell, ".PRON")) %>%
  separate_wider_position(cell, c(person = 1, number = 2)) %>%
  pivot_wider(., names_from = number, values_from = analysed_phon_form) %>% 
  rename(`Person/Number` = person)
# write to docs folder
write_csv(pronouns_visual, here("PARALEX/ranglong/docs/pronoun_table.csv"))

# intransitives
intr_prep <- forms_scen %>%
  filter(!str_detect(cell, "PRON"), !str_detect(cell, "-")) %>%
  select(cell, analysed_phon_form, ends_with("tag"), TENSE_ASPECT, POLARITY) %>%
  separate_wider_delim(cell, delim = ".", names = c("person", "tap")) %>%
  unite("TAP", TENSE_ASPECT:POLARITY, sep = ".") %>%
  split(f = as.factor(.$TAP)) %>%
  map(., ~select(., -tap, -TAP))

intr_visual <- bind_rows(
  map2(names(intr_prep), intr_prep, function(name, df) {
    title_row <- data.frame(matrix(NA, nrow = 1, ncol = ncol(df)))
    colnames(title_row) <- colnames(df)
    title_row[1, 1] <- name
    combined <- bind_rows(title_row, df)
    return(combined)
  })
)
# write to docs folder
write_csv(intr_visual, here("PARALEX/ranglong/docs/intransitive_tables.csv"), na = "")
```

```{r}

forms_scen %>%
  filter(str_detect(cell, "1SG-3PL.FN"))

# transitive cross table
trans_prep <- forms_scen %>%
  filter(str_detect(cell, "-")) %>%
  select(cell, analysed_phon_form, starts_with("A_"), starts_with("O_"), TENSE_ASPECT, POLARITY, ends_with("tag")) %>% 
  unite("TAP", TENSE_ASPECT:POLARITY, sep = ".") %>%
  unite("A", starts_with("A_"), sep = "", na.rm = TRUE) %>%
  unite("O", starts_with("O_"), sep = "", na.rm = TRUE) %>%
  split(f = as.factor(.$TAP)) %>%
  map(., ~pivot_wider(., id_cols = c(A, paradigm_tag, variants_tag), names_from = O, values_from = analysed_phon_form)) %>%
  map(., ~select(., `A/O` = A, `1SG`, `1PL`, `2SG`:`3PL`, ends_with("tag")))

trans_visual <- bind_rows(
  map2(names(trans_prep), trans_prep, function(name, df) {
    # Create a title row
    title_row <- data.frame(matrix(NA, nrow = 1, ncol = ncol(df)))
    colnames(title_row) <- colnames(df)
    title_row[1, 1] <- name  # Set the first cell to the name of the data frame
    
    # Create a row for column names
    column_names_row <- data.frame(matrix(NA, nrow = 1, ncol = ncol(df)))
    colnames(column_names_row) <- colnames(df)
    column_names_row[1, ] <- colnames(df)  # Set the row to the column names
    
    # Combine title row, column names row, and data frame
    combined <- bind_rows(title_row, column_names_row, df, column_names_row) %>%
      filter(row_number() <= n()-1) %>%
      as_tibble()
    return(combined)
  })
)
glimpse(trans_visual)

# write to docs folder
write_csv(trans_visual, here("PARALEX/ranglong/docs/transitive_tables.csv"), na = "", col_names = FALSE)
```

```{r}
morphs_test_num <- morphs_test %>%
  mutate(TENSE_ASPECT = case_match(TENSE_ASPECT,
                             "NFUT" ~ 0,
                             "FUT" ~ 1),
         POLARITY = case_match(POLARITY,
                             "AFF" ~ 0,
                             "NEG" ~ 1),
         position = case_match(position,
                               "pre" ~ 1,
                               "post" ~ 2,
                               .default = 3)) %>%
  mutate(across(ends_with("Number"), ~case_match(.x,
                                                 "SG" ~ 1,
                                                 "DU" ~ 2,
                                                 "PL" ~ 3))) %>%
  mutate(across(ends_with("Clusivity"), ~case_match(.x,
                                                 "INCL" ~ 2,
                                                 "EXCL" ~ 1,
                                                 .default = 0))) %>%
  mutate(Scen_Person = as.numeric(Scen_Person))
  
glimpse(morphs_test_num)
summary(morphs_test)
  
ggplot(morphs_test) +
  #geom_mosaic(aes(x = product(morpheme), fill = TENSE_ASPECT))
  geom_histogram(aes(fill = POLARITY, x = TENSE_ASPECT), stat = "count", position = "fill") +
  facet_wrap(~morpheme)


ggplot(morphs_test) +
  #geom_mosaic(aes(x = product(morpheme), fill = TENSE_ASPECT))
  geom_histogram(aes(fill = A_Number, x = A_Person), stat = "count", position = "fill") +
  facet_wrap(~morpheme)
  
```

# Use Cases/Analyses for Pavia talk

## Gather forms from PARALEX

```{r}
#| output: false
# languages to include for this analysis; oder alphabetically
#lang_include <- c("anal", "chiru", "hmar", "hyow", "lamkang", "monsang", "pangkhua", "ranglong")

# list files from PARALEX subfolders
data_path <- here("PARALEX/")
# read in files and combine into one data frame per file type (cells, forms, etc.)
## forms
forms_include <- list.files(path = here("PARALEX/"), pattern = "*._forms.csv", recursive = TRUE)
forms_combined <- forms_include %>%
  map(~read_csv(file.path(data_path, .), col_types = cols(.default = "c"))) %>%
  bind_rows(.)
## features
features_include <- list.files(path = here("PARALEX/"), pattern = "*._features.csv", recursive = TRUE)
features_combined <- features_include %>%
  map(~read_csv(file.path(data_path, .))) %>%
  bind_rows(.)
## cells
cells_include <- list.files(path = here("PARALEX/"), pattern = "*._cells.csv", recursive = TRUE)
cells_combined <- cells_include %>%
  map(~read_csv(file.path(data_path, .))) %>%
  bind_rows(.)
## sounds
sounds_include <- list.files(path = here("PARALEX/"), pattern = "*._sounds.csv", recursive = TRUE)
sounds_combined <- sounds_include %>%
  map(~read_csv(file.path(data_path, .))) %>%
  bind_rows(.)
```

## Prepare analysis file with counts

```{r}
#| output: false
#| 
# merge forms with scenario file for analysis; strip tones for current analysis; take out pronouns
# for now, take out dual forms
scenarios <- read_tsv(here("paradigms_in/scenarios.tsv"))

forms_combined_subset <- forms_combined %>%
  mutate(across(contains("phon"), ~str_remove_all(., "⁵|¹|¹⁵|⁵¹"))) %>%
  mutate(across(contains("phon"), ~str_squish(.x))) %>%
  left_join(., scenarios, by = "cell") %>% 
  #mutate(across(contains("number"), ~if_else(language_id=="anal"&.x=="du", "pl", .x))) %>%
  filter(!(str_detect(cell, "du"))) %>%
  filter(MarkingType!="pronominal")
  #filter(!(language_id=="pangkhua"&str_detect(cell, "DU")))
glimpse(forms_combined)

# add counts for number of phonemes and morphemes per form
forms_comb_counts <- forms_combined_subset %>%
  mutate(phon_form_ns = str_remove_all(analysed_phon_form, "-")) %>%
  mutate(phon_form_ns = str_remove_all(phon_form_ns, " ")) %>%
  mutate(analysed_phon_form_ns = str_remove_all(analysed_phon_form, " ")) %>%
  mutate(segments_count = str_count(phon_form_ns)-1) %>%
  mutate(morphemes_count = str_count(analysed_phon_form_ns, pattern = "-")) %>%
  separate_wider_delim(phon_form_ns, delim = "Σ", names = c("s_before", "s_after"), cols_remove = FALSE, too_few = "align_start") %>% 
  separate_wider_delim(analysed_phon_form_ns, delim = "Σ", names = c("m_before", "m_after"), cols_remove = FALSE, too_few = "align_start") %>% 
  mutate(segments_before = str_count(s_before)) %>%
  mutate(segments_after = str_count(s_after)) %>%
  mutate(morphemes_before = str_count(m_before, pattern = "-")) %>%
  mutate(morphemes_after = str_count(m_after, pattern = "-")) %>%
  select(-starts_with("m_"), -starts_with("s_")) %>%
  clean_names()
glimpse(forms_comb_counts)

```

## Overviews: languages, forms, map etc.

```{r}
# metadata for map
metadata <- read_tsv(here("metadata.tsv")) %>%
  clean_names()
# languages and number of data points, scenarios
sample <- forms_comb_counts %>%
  group_by(language_id) %>%
  summarize(n_entries = n(), n_scenarios = n_distinct(cell)) %>%
  left_join(., metadata)
glimpse(sample)
```

## Overt coding in local vs. other scenarios

Length

```{r}
# make language name into factor for sorting and display; recode inclusive as separate person category
forms_comb_analysis <- forms_comb_counts %>%
  mutate(language_name = factor(str_to_title(language_id), levels = c("Ranglong", "Chiru", "Anal", "Monsang", "Lamkang", "Hmar", "Pangkhua", "Hyow"))) %>%
  mutate(across(ends_with("_person"), ~as.character(.x))) %>%
  mutate(a_person = case_when(a_clusivity=="INCL" ~ "INCL",
                              .default = a_person)) %>%
  mutate(o_person = case_when(o_clusivity=="INCL" ~ "INCL",
                              .default = o_person)) %>%
  mutate(scen_incl_any = case_when(a_clusivity=="INCL" ~ "yes",
                               o_clusivity=="INCL" ~ "yes",
                              .default = "no")) %>% 
  mutate(scen_incl_only = case_when(a_clusivity=="INCL"&is.na(o_person) ~ "INCL",
                                    a_clusivity!="INCL"&is.na(o_person) ~ "other",
                                    is.na(a_clusivity)&is.na(o_person) ~ "other",
                                    a_clusivity=="INCL"&o_clusivity!="INCL" ~ "INCL>other",
                                    a_clusivity=="INCL"&is.na(o_clusivity) ~ "INCL>other",
                                    a_clusivity!="INCL"&o_clusivity=="INCL" ~ "other>INCL",
                                    is.na(a_clusivity)&o_clusivity=="INCL" ~ "other>INCL",
                                    .default = "other>other")) %>%
  relocate(starts_with("scen_incl"), .after = cell) %>%
  droplevels()
glimpse(forms_comb_analysis)

# length in phonemes
# language profiles
summary(forms_comb_analysis$segments_count)
ggplot(forms_comb_analysis, aes(x = tense_aspect, y = segments_count, fill = polarity)) +
  geom_boxplot() +
  #geom_bar(position = "dodge") +
  scale_fill_bmj() +
  #scale_x_continuous(limits = c(0, max(forms_comb_counts$segments_count)), breaks = seq(1, max(forms_comb_counts$segments_count), 1)) +
  labs(y = "length in phonemes") +
  facet_wrap(~language_name) +
  theme_bw()
```

```{r}
# length in morphemes
# language profiles
summary(forms_comb_analysis$morphemes_count)
ggplot(forms_comb_analysis, aes(x = tense_aspect, y = morphemes_count, fill = polarity)) +
  #geom_bar(position = "fill") +
  geom_boxplot() +
  scale_fill_bmj() +
  #scale_x_continuous(limits = c(1, max(forms_comb_counts$morphemes_count)), breaks = seq(1, max(forms_comb_counts$morphemes_count), 1)) +
  labs(y = "length in morphemes") +
  facet_wrap(~language_name) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())
```

before and after, affirmative/negative

```{r}

ggplot(forms_comb_analysis, aes(y = morphemes_count, x = tense_aspect, fill = polarity)) +
  #geom_bar(position = "fill") +
  geom_jitter(size = 0.5) +
  geom_boxplot(alpha = 0.8) +
  scale_fill_bmj(name = "Polarity") +
  scale_color_bmj() +
  scale_y_continuous(limits = c(0, max(forms_comb_counts$morphemes_count)), breaks = seq(0, max(forms_comb_analysis$morphemes_count), 1)) +
  labs(y = "# of morphemes", x = "Tense") +
  facet_wrap(~language_name) +
  theme_bw() +
  theme(legend.position.inside = c(0.9, 0.1))

```

```{r}
# transitive forms only; exclude first on first;
transitives <- forms_comb_analysis %>%
  filter(!is.na(scen_person), scen_person!="1>1", scen_person!="2>2") %>%
  mutate(tense_aspect = factor(tense_aspect, levels = c("NFUT", "FUT"))) %>%
  mutate(scen_combined = if_else(scen_incl_only=="other>other", scen_person, scen_incl_only)) %>% view()
  smutate(scen_person = factor(scen_person, levels = c("1>2", "2>1", "3>1", "3>2", "1>3", "2>3", "3>3"))) %>% 
  mutate(scen_combined = factor(scen_combined, levels = c("1>2", "2>1", "other>INCL", "3>1", "3>2", "INCL>other", "1>3", "2>3", "3>3"))) %>%
  mutate(scen_color = as.factor(case_match(scen_combined,
                                 "1>2" ~ "local",
                                 "2>1" ~ "local",
                                 "other>INCL" ~ "inverse",
                                 "3>1" ~ "inverse",
                                 "3>2" ~ "inverse",
                                 "INCL>other" ~ "direct",
                                 "1>3" ~ "direct",
                                 "2>3" ~ "direct",
                                 "3>3" ~ "non-local"))
  )
glimpse(transitives)

transitives_aff <- transitives %>% 
  filter(polarity=="AFF")

ggplot(transitives_aff, aes(y = segments_count, x = scen_person, fill = scen_color)) +
  #geom_bar(position = "fill") +
  #geom_jitter(size = 0.5) +
  geom_violin(alpha = 0.8) +
  scale_fill_bmj(guide = "none") +
  scale_color_bmj() +
  scale_y_continuous(limits = c(0, max(transitives_aff$segments_count)), breaks = seq(0, max(transitives_aff$segments_count), 1)) +
  labs(y = "# of segments", x = "Scenario") +
  facet_wrap(~tense_aspect) +
  theme_bw() +
  theme()

violin_trans_scenarios <- ggplot(transitives_aff, aes(x = scen_combined, y = segments_count, fill = scen_color)) +
  geom_violin() +
  scale_fill_bmj(guide = "none") +
  scale_color_bmj() +
  scale_y_continuous(limits = c(0, max(transitives_aff$segments_count)), breaks = seq(0, max(transitives_aff$segments_count), 1)) +
  labs(y = "# of segments", x = "Scenario") +
  facet_grid(tense_aspect ~ language_name) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(size = 11))
violin_trans_scenarios

# write out to file
ggsave(here("plots/overview_phonemes_per_scenario.png"), violin_trans_scenarios, height = 17, width = 30, units = "cm", dpi = 600)
```

```{r}
library(cowplot)

transitives_aff_split <- group_split(transitives_aff, language_name) %>%
  setNames(levels(transitives_aff$language_name))

plots_transitive_aff <- lapply(names(transitives_aff_split), function(i) {
  ggplot(transitives_aff_split[[i]], aes(x = scen_combined, y = segments_count, fill = scen_color)) +
    geom_violin() +
    scale_fill_bmj(name = "Type of Scenario") +
    stat_summary(fun.data=mean_sdl, geom="pointrange", color = "grey20", size = 0.3, show.legend = FALSE) +
    scale_y_continuous(breaks = seq(0, max(transitives_aff_split[[i]]$segments_count), 1)) +
    labs(title = paste(i, "- TR.AFF"), y = "Length in phonemes", x = "Scenario") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          strip.text.x = element_text(size = 12),
          axis.title.x = element_blank())
})
plots_transitive_aff

plots_transitive_aff_grid <- ggarrange(plotlist = plots_transitive_aff, 
                                       ncol = 4, nrow = 2, align = "hv",
                                       common.legend = TRUE, legend = "top")
plots_transitive_aff_grid

# write out to file
ggsave(here("plots/length_scenario_tr_aff.png"), plots_transitive_aff_grid, height = 25, width = 45, units = "cm", dpi = 600)
```

```{r}
transitives_neg <- transitives %>% 
  filter(polarity=="NEG")

transitives_neg_split <- group_split(transitives_neg, language_name) %>%
  setNames(levels(transitives_neg$language_name))

plots_transitive_neg <- lapply(names(transitives_neg_split), function(i) {
  ggplot(transitives_neg_split[[i]], aes(x = scen_combined, y = segments_count, fill = scen_color)) +
    geom_violin() +
    stat_summary(fun.data=mean_sdl, geom="pointrange", color = "grey20", size = 0.3, show.legend = FALSE) +
    scale_fill_bmj(name = "Type of Scenario") +
    scale_y_continuous(breaks = seq(0, max(transitives_neg_split[[i]]$segments_count), 1)) +
    labs(title = paste(i, "- TR.NEG"), y = "Length in phonemes", x = "Scenario") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          strip.text.x = element_text(size = 12),
          axis.title.x = element_blank())
})
plots_transitive_neg

plots_transitive_neg_grid <- ggarrange(plotlist = plots_transitive_neg, 
                                       ncol = 4, nrow = 2, align = "hv",
                                       common.legend = TRUE, legend = "top")
plots_transitive_neg_grid

# write out to file
ggsave(here("plots/length_scenario_tr_neg.png"), plots_transitive_neg_grid, height = 25, width = 45, units = "cm", dpi = 600)

# plots_transitives_comb <- ggarrange(plotlist = plots_transitive_aff, 
#                                        ncol = 4, nrow = 2, align = "hv",
#                                        common.legend = TRUE, legend = "top")
# plots_transitives_comb
```

```{r}
# plot intransitive forms
intransitives <- forms_comb_analysis %>%
  filter(is.na(o_person)) %>%
  mutate(a_number = case_when(a_clusivity=="INCL" ~ "INCL", 
                              .default = a_number)) %>% 
  mutate(a_number = factor(a_number, levels = c("SG", "PL", "INCL"))) %>%
  mutate(a_person = factor(a_person, levels = c("1", "2", "3", "INCL")))
glimpse(intransitives)

# plot intransitives
violin_intransitive <- ggplot(intransitives) +
  geom_violin(aes(x = a_person, y = segments_count, fill = a_number)) +
  scale_fill_bmj() +
  scale_y_continuous(breaks = seq(1, 10, 1)) +
  facet_wrap(~language_name, ncol = 4) +
  labs(y = "Length in phonemes", x = "Person of S") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        strip.text.x = element_text(size = 12),
        axis.title = element_text(size = 12))
violin_intransitive

# write out to file
ggsave(here("plots/length_scenario_intr_aff.png"), violin_intransitive, height = 18, width = 30, units = "cm", dpi = 600)
```

### Regression model: predicting the number of phonemes/morphemes

```{r}
library(lme4)
glimpse(transitives_aff)

scen_phon_model <- glmer(segments_count ~ scen_combined + (1 | language_id), data = transitives_aff, family = poisson)
summary(scen_phon_model)

pred_scen_phon_model <- tibble()
pred_test <- predict(scen_phon_model, newdata = , type = "response") %>%
  as_tibble() %>%
  bind_cols(., transitives_aff)
glimpse(pred_test)

ggplot(pred_test) +
  geom_point(aes(x = scen_person, y = segments_count, color = language_name), shape = 1, alpha = 0.5) +
  geom_point(aes(x = scen_person, y = value, color = language_name)) +
  scale_color_bmj()
  #facet_wrap(~language_name)
  

```

## Inclusive - heterogeneity/structural diversity

```{r}
# file for analysis excluding languages that do not have inclusive forms; add a variable indicating whether the form has an inclusive (in S, A, or O)
forms_inclusive <- forms_comb_analysis %>%
  filter(language_id!="ranglong", language_id!="pangkhua") %>%
  droplevels()
  # mutate(incl_any = case_when(a_clusivity=="INCL" ~ "yes",
  #                              o_clusivity=="INCL" ~ "yes",
  #                             .default = "no")) %>%
  # mutate(incl_scen = case_when(a_clusivity=="INCL"&is.na(o_person) ~ "INCL",
  #                              a_clusivity=="INCL"&o_clusivity=="INCL" ~ "INCL>INCL",
  #                              a_clusivity=="INCL"&o_clusivity!="INCL" ~ "INCL>other",
  #                              a_clusivity=="INCL"&is.na(o_clusivity) ~ "INCL>other",
  #                              a_clusivity!="INCL"|is.na(a_clusivity)&o_clusivity=="INCL" ~ "other>INCL",
  #                              a_clusivity!="INCL"|is.na(a_clusivity)&o_clusivity=="INCL" ~ "other>INCL",
  #                              .default = "other>other")) %>%
  # relocate(starts_with("incl"), .after = cell) %>%
  # droplevels()
head(forms_inclusive)
```

chiru_dist \<- all_dist_per_lang(chiru_lv, chiru_phon_dist, "Chiru")

anal_dist \<- all_dist_per_lang(anal_lv, anal_phon_dist, "Anal")

monsang_dist \<- all_dist_per_lang(monsang_lv, monsang_phon_dist, "Monsang")

lamkang_dist \<- all_dist_per_lang(lamkang_lv, lamkang_phon_dist, "Lamkang")

hmar_dist \<- all_dist_per_lang(hmar_lv, hmar_phon_dist, "Hmar")

anal_dist \<- all_dist_per_lang(hyow_lv, hyow_phon_dist, "Hyow")

```{r}
# load packages
library(stringdist)
library(alineR)

# subset for distance analysis; take out copy vowel forms (except for one)
inclusive_modified <- forms_inclusive %>%
  mutate(phon_form_comp = str_remove_all(analysed_phon_form, "- ")) %>%
  mutate(phon_form_comp = str_remove_all(phon_form_comp, "Σ")) %>%
  mutate(phon_form_comp = str_squish(phon_form_comp)) %>%
  arrange(language_id, cell, phon_form_comp) %>%
  distinct(pick(cell, overabundance_tag, language_id), .keep_all = TRUE)

inclusive_sets <- inclusive_modified %>%
  select(language_name, form_id, cell, phon_form_comp, analysed_phon_form) %>%
  group_split(language_name) %>%
  setNames(levels(forms_inclusive$language_name))

inclusive_sets_a <- inclusive_modified %>%
  filter(o_clusivity!="INCL"|is.na(o_clusivity)) %>%
  droplevels() %>%
  select(language_name, form_id, cell, phon_form_comp, analysed_phon_form) %>%
  group_split(language_name) %>%
  setNames(levels(forms_inclusive$language_name))

inclusive_sets_nfa <- inclusive_modified %>%
  filter(polarity=="AFF", tense_aspect=="NFUT") %>%
  droplevels() %>%
  select(language_name, form_id, cell, phon_form_comp, analysed_phon_form) %>%
  group_split(language_name) %>%
  setNames(levels(forms_inclusive$language_name))

# Levenstein distance
lv_dist_per_lang <- function(l){
  stringdistmatrix(inclusive_sets[[l]][["phon_form_comp"]], useNames = TRUE) %>%
  as.matrix() %>%
  as_tibble(., rownames = NA) %>%
  rownames_to_column(var = "form1") %>%
  pivot_longer(-form1, names_to = "form2", values_to = "lv_distance") %>%
  filter(!str_detect(form2, "\\d+")) %>%
  distinct()
}

chiru_lv <- lv_dist_per_lang("Chiru")
anal_lv <- lv_dist_per_lang("Anal")
lamkang_lv <- lv_dist_per_lang("Lamkang")
monsang_lv <- lv_dist_per_lang("Monsang")
hmar_lv <- lv_dist_per_lang("Hmar")
hyow_lv <- lv_dist_per_lang("Hyow")

# phonological distance with alineR
phon_dist_per_lang <- function(p){
  pairs <- combn(inclusive_sets[[p]][["phon_form_comp"]], 2, simplify = FALSE) %>%
    as.matrix() %>%
    as_tibble() %>%
    unnest_wider(V1, names_sep = "_") %>%
    rename(form1 = V1_1, form2 = V1_2) %>%
    distinct()

  phon_distance <- pairs %>%
    mutate(phon_distance = aline(form1, form2))
  return(phon_distance)
}

chiru_phon_dist <- phon_dist_per_lang("Chiru")
anal_phon_dist <- phon_dist_per_lang("Anal")
monsang_phon_dist <- phon_dist_per_lang("Monsang")
lamkang_phon_dist <- phon_dist_per_lang("Lamkang")
hmar_phon_dist <- phon_dist_per_lang("Hmar")
hyow_phon_dist <- phon_dist_per_lang("Hyow")

# combine into one dataframe for analysis
all_dist_per_lang <- function(a, b, c){
  df <- full_join(a, b) %>%
  mutate(phon_distance = case_when(is.na(phon_distance) ~ 0, 
                               .default = phon_distance)) %>%
  full_join(., inclusive_sets[[c]], by = c("form1"="phon_form_comp"), 
            relationship = "many-to-many", multiple = "all") %>%
  full_join(., inclusive_sets[[c]], by = c("form2"="phon_form_comp"), 
            relationship = "many-to-many", multiple = "all", 
            suffix = c("1", "2")) %>%
  select(language_name = language_name1, form1, form_id1, form2, form_id2, lv_distance, phon_distance, cell1, cell2, analysed_phon_form1, analysed_phon_form2) %>%
  filter(form_id1!=form_id2) %>%
  left_join(., select(forms_inclusive, form_id, cell, starts_with("scen_"), ends_with("_tag"), tense_aspect:o_clusivity, segments_count:morphemes_after), by = c("form_id1" = "form_id")) %>%
  left_join(., select(forms_inclusive, form_id, cell, starts_with("scen_"), ends_with("_tag"), tense_aspect:o_clusivity, segments_count:morphemes_after), by = c("form_id2" = "form_id"), suffix = c("1", "2"))
}

chiru_dist <- all_dist_per_lang(chiru_lv, chiru_phon_dist, "Chiru")
anal_dist <- all_dist_per_lang(anal_lv, anal_phon_dist, "Anal")
monsang_dist <- all_dist_per_lang(monsang_lv, monsang_phon_dist, "Monsang")
lamkang_dist <- all_dist_per_lang(lamkang_lv, lamkang_phon_dist, "Lamkang")
hmar_dist <- all_dist_per_lang(hmar_lv, hmar_phon_dist, "Hmar")
hyow_dist <- all_dist_per_lang(hyow_lv, hyow_phon_dist, "Hyow")

```

```{r}
ggplot(hmar_dist) +
  geom_boxplot(aes(y = phon_distance, x = tense_aspect1, fill = tense_aspect2))
```

```{r}
library(datawizard)
# calculate means and medians
dist_by_group <- function(d){
  d %>%
  mutate(lv_distance_norm = normalize(lv_distance)) %>% 
  relocate(lv_distance_norm, .after = lv_distance) %>%
  mutate(config = case_when(scen_incl_any1=="yes"&scen_incl_any2=="yes" ~ "both INCL",
                            scen_incl_any1=="no"&scen_incl_any2=="no" ~ "no INCL",
                            .default = "mixed")) %>%
  group_by(config) %>% 
  summarize(mean_phon = mean(phon_distance, na.rm = TRUE), 
            median_phon = median(phon_distance, na.rm = TRUE),
            mean_edit = mean(lv_distance_norm, na.rm = TRUE), 
            median_edit = median(lv_distance_norm, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_longer(., mean_phon:median_edit, names_to = "Measure", values_to = "Value") %>%
  separate_wider_delim(Measure, delim = "_", names = c("Measure", "Type")) %>%
  mutate(Measure = as_factor(Measure), Type = as_factor(Type))
}

chiru_dist_by_group <- dist_by_group(chiru_dist)
anal_dist_by_group <- dist_by_group(anal_dist)
monsang_dist_by_group <- dist_by_group(monsang_dist)
lamkang_dist_by_group <- dist_by_group(lamkang_dist)
hmar_dist_by_group <- dist_by_group(hmar_dist)
hyow_dist_by_group <- dist_by_group(hyow_dist)


dist_plot <- function(p, l){
  ggplot(p) +
  geom_point(aes(x = config, y = Value, color = Type, shape = Measure), size = 3) +
  #stat_summary(aes(x = config, y = Value, group = Type, color = Type), fun.data=mean_sdl, geom="pointrange", size = 0.3) +
  scale_color_bmj() +
  scale_y_continuous(limits = c(0, 0.55)) +
  labs(title = paste(l),y = "Normalized pairwise distance") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        legend.position="bottom")
}

chiru_dist_plot <- dist_plot(chiru_dist_by_group, "Chiru")
anal_dist_plot <- dist_plot(anal_dist_by_group, "Anal")
monsang_dist_plot <- dist_plot(monsang_dist_by_group, "Monsang")
lamkang_dist_plot <- dist_plot(lamkang_dist_by_group, "Lamkang")
hmar_dist_plot <- dist_plot(hmar_dist_by_group, "Hmar")
hyow_dist_plot <- dist_plot(hyow_dist_by_group, "Hyow")

legend <- get_legend(chiru_dist_plot)
dist_plot_grid <- ggarrange(chiru_dist_plot, anal_dist_plot, monsang_dist_plot, lamkang_dist_plot, hmar_dist_plot, hyow_dist_plot, 
                            ncol = 3, nrow = 2, align = "hv",
                                       common.legend = TRUE, legend = "bottom")
dist_plot_grid
# write out to file
ggsave(here("plots/dist_incl_all.png"), dist_plot_grid, height = 15, width = 23, units = "cm", dpi = 600)
```

```{r}

```
